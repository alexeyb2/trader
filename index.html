<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ–∏–∫ —Å –≤–æ–ª–Ω–∞–º–∏</title>
    <style>
        html, body {
            padding: 0;
            margin: 0;
            font-family: Arial, sans-serif;
            width: 100%;
            height: 100%;
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        #container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        #forWrite {
            position: absolute;
            z-index: 1;
            font-size: small;
            display: block;
            left: 0;
            top: 0;
            background: rgba(255,255,255,0.8);
            padding: 2px 5px;
            border-radius: 3px;
        }
        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥–∞) */
        #controlPanel {
            position: absolute;
            z-index: 3;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        #authToggleBtn {
            background: #007bff;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: none;
            margin-bottom: 10px;
        }
        #authForm {
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            max-width: 280px;
            width: 80vw;
            display: none;
            flex-direction: column;
        }
        #authForm.visible {
            display: flex;
        }
        #authForm input, #authForm select {
            margin: 8px 0;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #authForm button {
            margin-top: 15px;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
        }
        #logoutBtn {
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            border: none;
            margin-top: 5px;
            display: none;
        }
        #userInfo {
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
            text-align: right;
        }
        /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –ø–æ–∑–∏—Ü–∏–∏ (–∫–∞–∫ —Ä–∞–Ω–µ–µ) */
        #entryForm {
            position: absolute;
            z-index: 2;
            top: 80px;
            right: 10px;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            max-width: 280px;
            width: 80vw;
            display: none;
        }
        #entryForm.visible {
            display: block;
        }
        #entryForm h3 {
            margin-top: 0;
            font-size: 16px;
            margin-bottom: 15px;
        }
        #entryForm input, #entryForm select {
            margin: 8px 0;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #entryForm button {
            margin-top: 15px;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
        }
        #toggleEntryFormBtn {
            position: absolute;
            z-index: 3;
            top: 10px;
            left: 10px;
            background: #28a745;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: none;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="forWrite">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <!-- –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="controlPanel">
        <button id="authToggleBtn">üîê</button>
        <div id="authForm">
            <h3 style="margin-top:0;">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
            <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ email">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="loginBtn">–í–æ–π—Ç–∏</button>
            <div id="userInfo"></div>
            <button id="logoutBtn">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞ –ø–æ–∑–∏—Ü–∏–∏ -->
    <button id="toggleEntryFormBtn">üìà</button>
    <div id="entryForm">
        <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∑–∏—Ü–∏–∏</h3>
        <div><label>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:</label><input type="number" id="entryPrice" step="any" placeholder="–¶–µ–Ω–∞"></div>
        <div><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label><input type="number" id="quantity" step="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"></div>
        <div><label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</label>
            <select id="direction">
                <option value="long">Long</option>
                <option value="short">Short</option>
            </select>
        </div>
        <div><label>–°—Ç–æ–ø-–ª–æ—Å—Å:</label><input type="number" id="stopLoss" step="any" placeholder="–°—Ç–æ–ø-–ª–æ—Å—Å"></div>
        <button id="saveEntry">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <script src="https://unpkg.com/lightweight-charts@4.2.3/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ccxt@4.4.86/dist/ccxt.browser.min.js"></script>
    <script>
        // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
        const API_BASE = ''; // –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ URL
        const urlParams = new URLSearchParams(window.location.search);
        const symbol = urlParams.get('n') || 'BTC';
        const tf = urlParams.get('tf') || '1m';

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let chart, mainSeries;
        let tickSize = 0.00000001;
        let priceDecimals = 8;
        let linesData = [];          // –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ª–∏–Ω–∏–π
        let wavesSeries = {};         // –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Ä–∏–π –≤–æ–ª–Ω
        let accessToken = localStorage.getItem('accessToken');
        let userInfo = null;

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
        const authToggleBtn = document.getElementById('authToggleBtn');
        const authForm = document.getElementById('authForm');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfoDiv = document.getElementById('userInfo');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const forWriteDiv = document.getElementById('forWrite');
        const toggleEntryFormBtn = document.getElementById('toggleEntryFormBtn');
        const entryForm = document.getElementById('entryForm');
        const saveEntryBtn = document.getElementById('saveEntry');
        const entryPrice = document.getElementById('entryPrice');
        const quantity = document.getElementById('quantity');
        const direction = document.getElementById('direction');
        const stopLoss = document.getElementById('stopLoss');

        // --- –£—Ç–∏–ª–∏—Ç—ã ---
        function showError(msg) {
            forWriteDiv.innerText = '–û—à–∏–±–∫–∞: ' + msg;
            console.error(msg);
        }

        // --- –†–∞–±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º ---
        function setToken(token) {
            accessToken = token;
            if (token) {
                localStorage.setItem('accessToken', token);
            } else {
                localStorage.removeItem('accessToken');
            }
        }

        // --- –ó–∞–ø—Ä–æ—Å —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π ---
        async function fetchWithAuth(url, options = {}) {
            if (!accessToken) {
                throw new Error('No token');
            }
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
                'Authorization': `Bearer ${accessToken}`
            };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) {
                // –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
                setToken(null);
                userInfo = null;
                updateAuthUI();
                throw new Error('Unauthorized');
            }
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`HTTP ${response.status}: ${text}`);
            }
            return response.json();
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ---
        async function login(username, password) {
            try {
                const response = await fetch(API_BASE + '/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Login failed');
                }
                const data = await response.json();
                // data: TokenResponse { access_token, token_type, expires_in, user_id, role, username }
                setToken(data.access_token);
                userInfo = {
                    id: data.user_id,
                    username: data.username,
                    role: data.role
                };
                updateAuthUI();
                // –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª–∞
                await loadSymbolData();
                return true;
            } catch (e) {
                showError('Login error: ' + e.message);
                return false;
            }
        }

        function logout() {
            setToken(null);
            userInfo = null;
            updateAuthUI();
            // –û—á–∏—â–∞–µ–º –ª–∏–Ω–∏–∏ —Å –≥—Ä–∞—Ñ–∏–∫–∞ (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—â–µ)
            location.reload();
        }

        function updateAuthUI() {
            if (userInfo) {
                userInfoDiv.innerText = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userInfo.username} (${userInfo.role})`;
                logoutBtn.style.display = 'block';
                loginBtn.style.display = 'none';
                loginUsername.disabled = true;
                loginPassword.disabled = true;
            } else {
                userInfoDiv.innerText = '';
                logoutBtn.style.display = 'none';
                loginBtn.style.display = 'block';
                loginUsername.disabled = false;
                loginPassword.disabled = false;
            }
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ ---
        async function loadSymbolData() {
            if (!accessToken) return;
            try {
                const response = await fetchWithAuth(API_BASE + '/api/get/', {
                    method: 'POST',
                    body: JSON.stringify({
                        table: 'symbols',
                        where: { symbol: symbol }
                    })
                });
                // response = { status: "success", data: { table, count, data: [ ... ] } }
                if (response.status !== 'success' || !response.data || !response.data.data || response.data.data.length === 0) {
                    throw new Error('Symbol not found');
                }
                const symbolRecord = response.data.data[0];
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º tickSize –∏–∑ info
                if (symbolRecord.info && symbolRecord.info.tick_size) {
                    tickSize = symbolRecord.info.tick_size;
                    priceDecimals = Math.max(0, Math.round(-Math.log10(tickSize)));
                }
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                if (symbolRecord.indicators_data) {
                    drawIndicators(symbolRecord.indicators_data);
                }
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —É—Ä–æ–≤–Ω–∏
                if (symbolRecord.levels && Array.isArray(symbolRecord.levels)) {
                    if (symbolRecord.levels[0]) drawLevels(symbolRecord.levels[0], 0, 'blue');
                    if (symbolRecord.levels[1]) drawLevels(symbolRecord.levels[1], 1, 'red');
                }
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–æ–ª–Ω—ã
                if (symbolRecord.wave) {
                    drawWaves(symbolRecord.wave);
                }
                forWriteDiv.innerText = `${symbol} ${tf} tick: ${tickSize}`;
            } catch (e) {
                if (e.message === 'Unauthorized') {
                    // —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π, —É–∂–µ —Å–±—Ä–æ—à–µ–Ω
                } else {
                    showError('Failed to load symbol data: ' + e.message);
                }
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ ---
        function initChart() {
            chart = LightweightCharts.createChart(document.getElementById('container'), {
                localization: {
                    priceFormatter: p => p.toFixed(priceDecimals)
                },
                timeScale: {
                    timeVisible: true,
                    barSpacing: 10
                }
            });
            mainSeries = chart.addCandlestickSeries();
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞) ---
        function addLine(price, settings) {
            const line = mainSeries.createPriceLine({
                price: price,
                color: settings.color || 'red',
                lineWidth: settings.lineWidth || 1,
                lineStyle: settings.lineStyle || 0,
                title: settings.title || '',
                axisLabelVisible: true
            });
            linesData.push({
                line: line,
                originalTitle: settings.title || '',
                price: price
            });
            return line;
        }

        function addWave(name, points, settings) {
            if (!points.length) return;
            const waveSeries = chart.addLineSeries({
                color: settings.color || 'blue',
                lineWidth: settings.lineWidth || 1,
                title: settings.title || name
            });
            const data = points.map(p => ({ time: p[0], value: p[1] }));
            waveSeries.setData(data);
            wavesSeries[name] = waveSeries;
        }

        function setMarkers(markers) {
            mainSeries.setMarkers(markers.map(m => ({
                time: m.time,
                position: m.position || 'inBar',
                color: m.color || 'red',
                shape: m.shape || 'circle',
                text: m.text || ''
            })));
        }

        function drawIndicators(indicators) {
            const names = ['bb_lower', 'bb_middle', 'bb_upper', 'sar'];
            const colors = ['red', 'green', 'blue', 'yellow', '#fde910'];
            let lineWidth = 1;
            for (const [tf, tfData] of Object.entries(indicators)) {
                names.forEach((name, idx) => {
                    if (tfData[name] && tfData[name][1] !== undefined) {
                        const price = tfData[name][1];
                        const title = `${tf}_${name}`;
                        addLine(price, {
                            title: title,
                            color: colors[idx],
                            lineWidth: lineWidth,
                            lineStyle: 1
                        });
                        if (name === 'sar' && tfData[name][0] !== undefined) {
                            addLine(tfData[name][0], {
                                title: title + '_before',
                                color: colors[4],
                                lineWidth: lineWidth,
                                lineStyle: 1
                            });
                        }
                    }
                });
                lineWidth++;
            }
        }

        function drawLevels(levels, direction, defaultColor) {
            if (!Array.isArray(levels)) return;
            levels.forEach(level => {
                if (level.price) {
                    addLine(level.price, {
                        title: `${level.tf || ''} ${level.by || ''} ${direction ? '–≤–µ—Ä—Ö' : '–Ω–∏–∑'}`,
                        color: defaultColor,
                        lineWidth: 1,
                        lineStyle: 0
                    });
                }
            });
        }

        function drawWaves(waveData) {
            if (!waveData || !waveData['..'] || !waveData[':']) return;
            const waveSettings = waveData[':'];
            const wavePoints = waveData['..'];
            function extractPoints(arr) {
                return arr
                    .filter(item => item && item['.'])
                    .map(item => item['.'])
                    .sort((a, b) => a[0] - b[0]);
            }
            if (wavePoints.limits && Array.isArray(wavePoints.limits)) {
                const points = extractPoints(wavePoints.limits);
                const settings = waveSettings.limits || {};
                const color = settings.direction === 1 ? 'green' : 'red';
                addWave('limits', points, { color: color, lineWidth: 2, title: 'limits' });
            }
            if (wavePoints.self && Array.isArray(wavePoints.self)) {
                const points = extractPoints(wavePoints.self);
                const settings = waveSettings.self || {};
                const color = settings.direction === 1 ? 'blue' : 'orange';
                addWave('self', points, { color: color, lineWidth: 1, title: 'self' });
            }
            const allMarkers = [];
            if (wavePoints.limits) {
                wavePoints.limits.forEach(item => {
                    if (item['.']) {
                        const time = item['.'][0];
                        const dir = item[':']?.direction;
                        allMarkers.push({
                            time: time,
                            position: 'belowBar',
                            color: dir === 1 ? 'green' : 'red',
                            shape: dir === 1 ? 'arrowUp' : 'arrowDown',
                            text: `L${dir}`
                        });
                    }
                });
            }
            if (wavePoints.self) {
                wavePoints.self.forEach(item => {
                    if (item['.']) {
                        const time = item['.'][0];
                        const dir = item[':']?.direction;
                        allMarkers.push({
                            time: time,
                            position: 'aboveBar',
                            color: dir === 1 ? 'blue' : 'orange',
                            shape: 'circle',
                            text: `S${dir}`
                        });
                    }
                });
            }
            if (allMarkers.length) setMarkers(allMarkers);
        }

        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ª–∏–Ω–∏–π —Å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º ---
        function updateLineTitles(currentPrice) {
            linesData.forEach(item => {
                const distance = (item.price - currentPrice) / tickSize;
                const sign = distance >= 0 ? '+' : '';
                item.line.applyOptions({
                    title: `${item.originalTitle} (${sign}${Math.round(distance)})`
                });
            });
        }

        // --- –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–≤–µ—á–µ–π —á–µ—Ä–µ–∑ CCXT ---
        async function startPriceUpdates() {
            const exchange = new ccxt.bybit({ enableRateLimit: true });
            const symbolPair = symbol + '/USDT:USDT';
            while (true) {
                try {
                    const ohlcv = await exchange.fetchOHLCV(symbolPair, tf, undefined, 200);
                    const data = ohlcv.map(([t, o, h, l, c]) => ({ time: t / 1000, open: o, high: h, low: l, close: c }));
                    mainSeries.setData(data);
                    if (data.length > 0) {
                        updateLineTitles(data[data.length - 1].close);
                    }
                } catch (e) {
                    console.error('CCXT error:', e);
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –≤–≤–æ–¥–∞ –ø–æ–∑–∏—Ü–∏–∏ (–∫–∞–∫ —Ä–∞–Ω–µ–µ) ---
        function initEntryForm() {
            let entryData = { price: null, quantity: null, direction: 'long', stopLoss: null };
            let entryLine = null;
            let stopLossLine = null;

            function createEntryLine() {
                if (!entryData.price) return;
                if (entryLine) mainSeries.removePriceLine(entryLine);
                const color = entryData.direction === 'long' ? '#00ff00' : '#ff0000';
                const lineStyle = entryData.direction === 'long' ? 0 : 2;
                entryLine = mainSeries.createPriceLine({
                    price: entryData.price,
                    color: color,
                    lineWidth: 2,
                    lineStyle: lineStyle,
                    title: '–í—Ö–æ–¥ ' + (entryData.quantity || ''),
                    axisLabelVisible: true
                });
            }

            function createStopLossLine() {
                if (!entryData.stopLoss) {
                    if (stopLossLine) { mainSeries.removePriceLine(stopLossLine); stopLossLine = null; }
                    return;
                }
                if (stopLossLine) mainSeries.removePriceLine(stopLossLine);
                stopLossLine = mainSeries.createPriceLine({
                    price: entryData.stopLoss,
                    color: '#ff6600',
                    lineWidth: 2,
                    lineStyle: 2,
                    title: 'Stop Loss',
                    axisLabelVisible: true
                });
            }

            function saveEntryData() {
                const price = parseFloat(entryPrice.value);
                const qty = parseFloat(quantity.value);
                const dir = direction.value;
                const sl = stopLoss.value ? parseFloat(stopLoss.value) : null;
                if (isNaN(price) || isNaN(qty)) { alert('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ'); return false; }
                entryData = { price, quantity: qty, direction: dir, stopLoss: sl };
                localStorage.setItem(`entryData_${symbol}`, JSON.stringify(entryData));
                createEntryLine();
                createStopLossLine();
                return true;
            }

            saveEntryBtn.addEventListener('click', saveEntryData);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
            const saved = localStorage.getItem(`entryData_${symbol}`);
            if (saved) {
                try {
                    entryData = JSON.parse(saved);
                    entryPrice.value = entryData.price || '';
                    quantity.value = entryData.quantity || '';
                    direction.value = entryData.direction || 'long';
                    stopLoss.value = entryData.stopLoss || '';
                    createEntryLine();
                    createStopLossLine();
                } catch (e) { }
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ UI ---
        authToggleBtn.addEventListener('click', () => {
            authForm.classList.toggle('visible');
        });

        loginBtn.addEventListener('click', async () => {
            const username = loginUsername.value.trim();
            const password = loginPassword.value;
            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            await login(username, password);
        });

        logoutBtn.addEventListener('click', logout);

        toggleEntryFormBtn.addEventListener('click', () => {
            entryForm.classList.toggle('visible');
        });

        // --- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ---
        async function main() {
            initChart();
            initEntryForm();

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            if (accessToken) {
                try {
                    // –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —á–µ—Ä–µ–∑ /api/auth/me
                    const meResponse = await fetchWithAuth(API_BASE + '/api/auth/me');
                    if (meResponse.status === 'success' && meResponse.data) {
                        userInfo = {
                            id: meResponse.data.id,
                            username: meResponse.data.name,
                            role: meResponse.data.role
                        };
                    }
                } catch (e) {
                    // –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, —É–∂–µ —Å–±—Ä–æ—à–µ–Ω
                }
                updateAuthUI();

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª–∞
                await loadSymbolData();
            } else {
                updateAuthUI();
            }

            // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–µ—á–µ–π
            startPriceUpdates();
        }

        main();
    </script>
</body>
</html>
